<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNAKE.IO | Ù†Ø³Ø®Ø© Ù…ØªÙˆØ§Ø²Ù†Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #050505; touch-action: none; font-family: 'Arial', sans-serif; }
        canvas { display: block; }
        .ui-screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: rgba(0,0,0,0.9); color: white; text-align: center; }
        .btn { padding: 15px 50px; margin: 10px; border: none; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; width: 240px; }
        .btn-start { background: #00e676; color: black; box-shadow: 0 0 20px #00e676; }
        input#username { padding: 15px; border-radius: 30px; border: 2px solid #444; background: #111; color: white; width: 240px; text-align: center; margin-bottom: 20px; outline: none; }
        .leaderboard { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 10px; color: white; min-width: 150px; pointer-events: none; font-size: 14px; border-right: 4px solid #00e676; }
        #joy-base { position: fixed; bottom: 50px; left: 50px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(255,255,255,0.3); border-radius: 50%; }
    </style>
</head>
<body>

    <div id="start-screen" class="ui-screen">
        <h1 style="color: #00e676;">Ø³Ù†ÙŠÙƒ Ø±ÙˆÙŠØ§Ù„</h1>
        <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ø«Ø¹Ø¨Ø§Ù†..." maxlength="10">
        <button class="btn btn-start" onclick="startGame()">Ø§Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="death-screen" class="ui-screen" style="display: none;">
        <h2 style="color: #ff1744;">ØªØ­Ø·Ù…Øª!</h2>
        <p id="score-text">0</p>
        <button class="btn btn-start" onclick="startGame()">Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </div>

    <div class="leaderboard" id="leaderboard"></div>
    <div id="joy-base"><div id="joy-stick"></div></div>
    <canvas id="ctx"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC_O3VFAZW3OZGrxxk2yK58Avgj-8WVs-M",
            authDomain: "alhelwyn.firebaseapp.com",
            projectId: "alhelwyn",
            databaseURL: "https://alhelwyn-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const canvas = document.getElementById('ctx');
        const gl = canvas.getContext('2d');
        const WORLD = 5000;
        let myId = "", players = {}, foods = {}, isLive = false, isBoosting = false;
        
        let me = { x: WORLD/2, y: WORLD/2, angle: 0, score: 0, body: [], color: `hsl(${Math.random()*360}, 80%, 60%)`, name: "" };

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();

        function startGame() {
            me.name = document.getElementById('username').value || "Ù„Ø§Ø¹Ø¨";
            me.score = 0; me.body = [];
            me.x = Math.random() * (WORLD - 1000) + 500;
            me.y = Math.random() * (WORLD - 1000) + 500;
            document.querySelectorAll('.ui-screen').forEach(s => s.style.display = 'none');
            if ('ontouchstart' in window) document.getElementById('joy-base').style.display = 'block';
            
            const ref = db.ref('v_final_fixed').push();
            myId = ref.key;
            db.ref('v_final_fixed/' + myId).onDisconnect().remove();
            isLive = true;
            
            // Ø±Ø³Ø¨Ù†Ø© Ø£ÙˆÙ„ÙŠØ© Ø®ÙÙŠÙØ©
            if (Object.keys(foods).length < 50) spawnFood(100);
            requestAnimationFrame(loop);
        }

        // ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
        window.addEventListener('mousemove', (e) => {
            if (!isLive || ('ontouchstart' in window)) return;
            me.angle = Math.atan2(e.clientY - canvas.height/2, e.clientX - canvas.width/2);
        });

        window.onmousedown = () => isBoosting = true;
        window.onmouseup = () => isBoosting = false;

        // ØªØ­ÙƒÙ… Ø§Ù„Ù„Ù…Ø³ Ù„Ù„Ø¬ÙˆØ§Ù„
        window.addEventListener('touchmove', (e) => {
            if (!isLive) return;
            const touch = e.touches[0];
            const base = document.getElementById('joy-base').getBoundingClientRect();
            const dx = touch.clientX - (base.left + 50);
            const dy = touch.clientY - (base.top + 50);
            me.angle = Math.atan2(dy, dx);
            const dist = Math.min(Math.hypot(dx, dy), 40);
            document.getElementById('joy-stick').style.transform = `translate(${Math.cos(me.angle)*dist}px, ${Math.sin(me.angle)*dist}px)`;
            isBoosting = e.touches.length > 1;
        }, { passive: false });

        db.ref('v_final_fixed').on('value', s => players = s.val() || {});
        db.ref('foods_fixed').on('value', s => foods = s.val() || {});

        function loop() {
            if(!isLive) return;

            let speed = isBoosting && me.score > 20 ? 3.8 : 2.3;
            if(isBoosting && me.score > 20) me.score -= 0.1;

            me.x += Math.cos(me.angle) * speed;
            me.y += Math.sin(me.angle) * speed;

            if(me.x < 0 || me.x > WORLD || me.y < 0 || me.y > WORLD) { die(); return; }

            // ØªØµØ§Ø¯Ù… (ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ­Øµ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡)
            for(let id in players) {
                if(id === myId) continue;
                let p = players[id]; if(!p.body) continue;
                let sz = Math.min(35, 14 + (p.score / 200));
                for(let i=0; i<p.body.length; i+=4) {
                    if(Math.hypot(me.x - p.body[i].x, me.y - p.body[i].y) < sz + 5) { die(); return; }
                }
            }

            me.body.unshift({x: me.x, y: me.y});
            if(me.body.length > 20 + (me.score/5)) me.body.pop();

            // Ø£ÙƒÙ„ (Ù†Ø¸Ø§Ù… Ø±Ø³Ø¨Ù†Ø© Ø¨Ø·ÙŠØ¡ ÙˆÙ…ØªØ²Ù†)
            for(let fId in foods) {
                if(Math.hypot(me.x - foods[fId].x, me.y - foods[fId].y) < 35) {
                    me.score += (foods[fId].v || 5);
                    db.ref('foods_fixed/' + fId).remove();
                }
            }

            // Ø¥Ø¨Ø·Ø§Ø¡ Ø§Ù„Ø±Ø³Ø¨Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ ÙØªØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)
            if(Math.random() > 0.96 && Object.keys(foods).length < 400) spawnFood(2);

            db.ref('v_final_fixed/' + myId).set(me);
            draw();
            requestAnimationFrame(loop);
        }

        function spawnFood(num = 1) {
            for(let i=0; i<num; i++){
                db.ref('foods_fixed').push({ 
                    x: Math.random() * WORLD, 
                    y: Math.random() * WORLD, 
                    c: `hsl(${Math.random()*360}, 100%, 60%)`, 
                    v: Math.random() > 0.95 ? 20 : 8 // ØªÙ‚Ù„ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙƒÙˆØ± Ø§Ù„ÙƒØ¨ÙŠØ±
                });
            }
        }

        function die() {
            isLive = false;
            me.body.forEach((p, i) => { if(i % 3 === 0) db.ref('foods_fixed').push({ x: p.x, y: p.y, c: me.color, v: 10 }); });
            db.ref('v_final_fixed/' + myId).remove();
            document.getElementById('score-text').innerText = "Ø§Ù„Ù†Ù‚Ø§Ø·: " + Math.floor(me.score);
            document.getElementById('death-screen').style.display = 'flex';
        }

        function draw() {
            gl.clearRect(0,0, canvas.width, canvas.height);
            gl.save();
            let zoom = Math.max(0.5, 1 - (me.score / 15000));
            gl.translate(canvas.width/2, canvas.height/2);
            gl.scale(zoom, zoom);
            gl.translate(-me.x, -me.y);

            // Ø´Ø¨ÙƒØ© Ø®ÙÙŠÙØ©
            gl.strokeStyle = "#111"; gl.lineWidth = 2;
            for(let i=0; i<=WORLD; i+=250) {
                gl.beginPath(); gl.moveTo(i, 0); gl.lineTo(i, WORLD); gl.stroke();
                gl.beginPath(); gl.moveTo(0, i); gl.lineTo(WORLD, i); gl.stroke();
            }

            for(let f in foods) {
                gl.fillStyle = foods[f].c;
                gl.beginPath(); gl.arc(foods[f].x, foods[f].y, (foods[f].v > 10 ? 10 : 6), 0, 7); gl.fill();
            }

            for(let id in players) {
                let p = players[id]; if(!p.body || p.body.length < 1) continue;
                let size = Math.min(35, 14 + (p.score / 200));
                gl.strokeStyle = p.color; gl.lineWidth = size*2; gl.lineCap = "round"; gl.lineJoin = "round";
                gl.beginPath(); gl.moveTo(p.body[0].x, p.body[0].y);
                p.body.forEach(b => gl.lineTo(b.x, b.y)); gl.stroke();
                
                gl.save(); gl.translate(p.body[0].x, p.body[0].y); gl.rotate(p.angle);
                gl.fillStyle = "white"; gl.beginPath(); gl.arc(size/2, -size/2, size/3, 0, 7); gl.fill();
                gl.beginPath(); gl.arc(size/2, size/2, size/3, 0, 7); gl.fill();
                gl.restore();
            }
            gl.restore();

            let top = Object.values(players).sort((a,b)=>b.score - a.score).slice(0,5);
            document.getElementById('leaderboard').innerHTML = "<b>ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</b><br>" + 
                top.map((p,i)=> `${i+1}. ${p.name}: ${Math.floor(p.score)}`).join('<br>');
        }
    </script>
</body>
</html>