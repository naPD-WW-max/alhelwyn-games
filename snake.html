<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNAKE REALISM | الثعبان الواقعي</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #080808; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        .leaderboard { position: fixed; top: 15px; right: 15px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; border: 1px solid #444; color: #fff; min-width: 140px; z-index: 100; font-size: 13px; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .btn { padding: 15px 40px; background: #222; color: #0f0; border: 2px solid #0f0; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="color: #0f0;">REALISTIC SNAKE IO</h1>
        <button class="btn" onclick="initGame()">دخول الساحة</button>
    </div>

    <div class="leaderboard">
        <div id="scores"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC_O3VFAZW3OZGrxxk2yK58Avgj-8WVs-M",
            authDomain: "alhelwyn.firebaseapp.com",
            projectId: "alhelwyn",
            databaseURL: "https://alhelwyn-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const WORLD_SIZE = 3000; 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let viewX = 0, viewY = 0;

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let myId = "", players = {}, foods = {};
        let mySnake = {
            x: WORLD_SIZE / 2, y: WORLD_SIZE / 2,
            body: [], angle: 0, score: 0,
            color: `hsl(${Math.random() * 360}, 70%, 50%)`,
            name: sessionStorage.getItem('userName') || "ثعبان"
        };

        function initGame() {
            document.getElementById('overlay').style.display = 'none';
            const ref = db.ref('real_snakes').push();
            myId = ref.key;
            setInterval(gameLoop, 1000/50);
            db.ref('real_snakes').on('value', s => players = s.val() || {});
            db.ref('real_foods').on('value', s => {
                foods = s.val() || {};
                if (Object.keys(foods).length < 40) spawnFood(20);
            });
        }

        function spawnFood(n) {
            for(let i=0; i<n; i++) {
                db.ref('real_foods').push({
                    x: Math.random() * WORLD_SIZE, y: Math.random() * WORLD_SIZE,
                    c: `hsl(${Math.random() * 360}, 100%, 50%)`
                });
            }
        }

        window.onmousemove = (e) => {
            mySnake.angle = Math.atan2(e.clientY - canvas.height/2, e.clientX - canvas.width/2);
        };

        function gameLoop() {
            if(!myId) return;
            const speed = 4;
            mySnake.x += Math.cos(mySnake.angle) * speed;
            mySnake.y += Math.sin(mySnake.angle) * speed;

            if(mySnake.x < 0 || mySnake.x > WORLD_SIZE || mySnake.y < 0 || mySnake.y > WORLD_SIZE) die();

            mySnake.body.unshift({x: mySnake.x, y: mySnake.y});
            if(mySnake.body.length > 20 + (mySnake.score / 5)) mySnake.body.pop();

            viewX = mySnake.x - canvas.width / 2;
            viewY = mySnake.y - canvas.height / 2;

            for(let id in foods) {
                if(Math.hypot(mySnake.x - foods[id].x, mySnake.y - foods[id].y) < 25) {
                    mySnake.score += 5;
                    db.ref('real_foods/'+id).remove();
                }
            }
            db.ref('real_snakes/'+myId).set(mySnake);
            draw();
        }

        function die() {
            db.ref('real_snakes/'+myId).remove();
            location.reload();
        }

        function drawSnake(p) {
            if (!p.body || p.body.length < 2) return;
            const thickness = Math.min(28, 10 + (p.score / 50));

            // 1. رسم الجسم كقطعة واحدة منحنية
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            ctx.lineWidth = thickness * 2;
            
            // تدرج لوني للجسم
            let gradient = ctx.createLinearGradient(p.body[0].x, p.body[0].y, p.body[p.body.length-1].x, p.body[p.body.length-1].y);
            gradient.addColorStop(0, p.color);
            gradient.addColorStop(1, "black");
            ctx.strokeStyle = gradient;

            ctx.beginPath();
            ctx.moveTo(p.body[0].x, p.body[0].y);
            for (let i = 1; i < p.body.length; i++) {
                ctx.lineTo(p.body[i].x, p.body[i].y);
            }
            ctx.stroke();

            // 2. رسم الرأس بشكل "بيضاوي" واقعي
            const head = p.body[0];
            ctx.save();
            ctx.translate(head.x, head.y);
            ctx.rotate(p.angle);
            
            // شكل الرأس
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, thickness * 1.5, thickness * 1.2, 0, 0, Math.PI * 2);
            ctx.fill();

            // اللسان (يتحرك تلقائياً)
            const tongueLen = 10 + Math.sin(Date.now() / 100) * 5;
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(thickness * 1.4, 0);
            ctx.lineTo(thickness * 1.4 + tongueLen, 0);
            ctx.stroke();

            // العيون
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(thickness * 0.6, -thickness * 0.5, thickness * 0.3, 0, 7); ctx.fill();
            ctx.beginPath(); ctx.arc(thickness * 0.6, thickness * 0.5, thickness * 0.3, 0, 7); ctx.fill();
            ctx.fillStyle = "black";
            ctx.beginPath(); ctx.arc(thickness * 0.7, -thickness * 0.5, thickness * 0.15, 0, 7); ctx.fill();
            ctx.beginPath(); ctx.arc(thickness * 0.7, thickness * 0.5, thickness * 0.15, 0, 7); ctx.fill();

            ctx.restore();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-viewX, -viewY);

            // حدود العالم حمراء مضيئة
            ctx.strokeStyle = "red"; ctx.lineWidth = 5;
            ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);

            // رسم الطعام
            for(let id in foods) {
                ctx.fillStyle = foods[id].c;
                ctx.beginPath(); ctx.arc(foods[id].x, foods[id].y, 5, 0, 7); ctx.fill();
            }

            // رسم اللاعبين
            for(let id in players) drawSnake(players[id]);

            ctx.restore();
            updateScores();
        }

        function updateScores() {
            let sorted = Object.values(players).sort((a,b) => b.score - a.score).slice(0,5);
            document.getElementById('scores').innerHTML = sorted.map(p => `<div>${p.name}: ${p.score}</div>`).join('');
        }
    </script>
</body>
</html>