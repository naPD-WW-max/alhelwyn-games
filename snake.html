<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNAKE PRO | Ù†Ø³Ø®Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„Ø­Ø§Ø¦Ø·</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; overflow: hidden; touch-action: none; }
        canvas { display: block; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: white; }
        .btn { padding: 15px 40px; background: #ff0000; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1.5rem; box-shadow: 0 0 20px #ff0000; }
        .leaderboard { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-family: sans-serif; font-size: 12px; pointer-events: none; border: 1px solid #ff0000; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>SNAKE REALISM</h1>
        <p>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„ØªØ­Ø±Ùƒ (Ù„Ù„Ø¬ÙˆØ§Ù„) Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø§ÙˆØ³</p>
        <button class="btn" onclick="initGame()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© âš”ï¸</button>
    </div>

    <div class="leaderboard" id="leaderboard"></div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC_O3VFAZW3OZGrxxk2yK58Avgj-8WVs-M",
            authDomain: "alhelwyn.firebaseapp.com",
            projectId: "alhelwyn",
            databaseURL: "https://alhelwyn-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const WORLD_SIZE = 3000; 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let viewX = 0, viewY = 0;

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let myId = "", players = {}, foods = {};
        let mySnake = {
            x: WORLD_SIZE / 2, y: WORLD_SIZE / 2,
            body: [], angle: 0, score: 0,
            color: `hsl(${Math.random() * 360}, 80%, 55%)`,
            name: sessionStorage.getItem('userName') || "Ø­Ù„Ùˆ"
        };

        function initGame() {
            document.getElementById('overlay').style.display = 'none';
            const ref = db.ref('mobile_arena').push();
            myId = ref.key;
            setInterval(gameLoop, 1000/50);
            db.ref('mobile_arena').on('value', s => players = s.val() || {});
            db.ref('mobile_foods').on('value', s => {
                foods = s.val() || {};
                if (Object.keys(foods).length < 40) spawnFood(20);
            });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… (Ù…Ø§ÙˆØ³ + Ù„Ù…Ø³) ---
        function updateAngle(clientX, clientY) {
            const dx = clientX - canvas.width / 2;
            const dy = clientY - canvas.height / 2;
            mySnake.angle = Math.atan2(dy, dx);
        }

        window.onmousemove = (e) => updateAngle(e.clientX, e.clientY);
        
        window.ontouchmove = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            updateAngle(touch.clientX, touch.clientY);
        };

        function spawnFood(n) {
            for(let i=0; i<n; i++) {
                db.ref('mobile_foods').push({
                    x: 20 + Math.random() * (WORLD_SIZE - 40),
                    y: 20 + Math.random() * (WORLD_SIZE - 40),
                    c: `hsl(${Math.random() * 360}, 100%, 50%)`
                });
            }
        }

        function gameLoop() {
            if(!myId) return;

            const speed = 4.2;
            mySnake.x += Math.cos(mySnake.angle) * speed;
            mySnake.y += Math.sin(mySnake.angle) * speed;

            // --- ÙØ­Øµ ØªØµØ§Ø¯Ù… Ø§Ù„Ø¬Ø¯Ø§Ø± (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚) ---
            if(mySnake.x <= 0 || mySnake.x >= WORLD_SIZE || mySnake.y <= 0 || mySnake.y >= WORLD_SIZE) {
                die();
                return;
            }

            mySnake.body.unshift({x: mySnake.x, y: mySnake.y});
            if(mySnake.body.length > 20 + (mySnake.score / 5)) mySnake.body.pop();

            viewX = mySnake.x - canvas.width / 2;
            viewY = mySnake.y - canvas.height / 2;

            // ØªØµØ§Ø¯Ù… Ø§Ù„Ø£ÙƒÙ„
            for(let id in foods) {
                if(Math.hypot(mySnake.x - foods[id].x, mySnake.y - foods[id].y) < 25) {
                    mySnake.score += 5;
                    db.ref('mobile_foods/'+id).remove();
                }
            }

            db.ref('mobile_arena/'+myId).set(mySnake);
            draw();
        }

        function die() {
            db.ref('mobile_arena/'+myId).remove();
            alert("ğŸ’¥ Ø§ØµØ·Ø¯Ù…Øª Ø¨Ø§Ù„Ø¬Ø¯Ø§Ø±! Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");
            location.reload();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-viewX, -viewY);

            // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¹Ø§Ù„Ù… (Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø­Ù…Ø± Ø§Ù„Ù‚Ø§ØªÙ„)
            ctx.strokeStyle = "#ff0000";
            ctx.lineWidth = 15;
            ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);

            // Ø±Ø³Ù… Ø§Ù„Ø·Ø¹Ø§Ù…
            for(let id in foods) {
                ctx.fillStyle = foods[id].c;
                ctx.beginPath(); ctx.arc(foods[id].x, foods[id].y, 5, 0, 7); ctx.fill();
            }

            // Ø±Ø³Ù… Ø§Ù„Ø«Ø¹Ø§Ø¨ÙŠÙ† Ø¨ÙˆØ§Ù‚Ø¹ÙŠØ©
            for(let id in players) {
                const p = players[id];
                if(!p.body || p.body.length < 2) continue;
                const thick = Math.min(25, 10 + (p.score/50));
                
                ctx.strokeStyle = p.color;
                ctx.lineWidth = thick * 2;
                ctx.lineCap = "round";
                ctx.lineJoin = "round";

                ctx.beginPath();
                ctx.moveTo(p.body[0].x, p.body[0].y);
                for(let i=1; i<p.body.length; i++) ctx.lineTo(p.body[i].x, p.body[i].y);
                ctx.stroke();

                // Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„Ø¹ÙŠÙˆÙ†
                ctx.save();
                ctx.translate(p.body[0].x, p.body[0].y);
                ctx.rotate(p.angle);
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.ellipse(0, 0, thick*1.4, thick*1.1, 0, 0, 7); ctx.fill();
                ctx.fillStyle = "white";
                ctx.beginPath(); ctx.arc(thick*0.6, -thick*0.4, thick*0.3, 0, 7); ctx.fill();
                ctx.beginPath(); ctx.arc(thick*0.6, thick*0.4, thick*0.3, 0, 7); ctx.fill();
                ctx.restore();
            }

            ctx.restore();
            updateLeaderboard();
        }

        function updateLeaderboard() {
            let sorted = Object.values(players).sort((a,b) => b.score - a.score).slice(0,5);
            document.getElementById('leaderboard').innerHTML = sorted.map(p => `<div>${p.name}: ${p.score}</div>`).join('');
        }

        window.onbeforeunload = () => { if(myId) db.ref('mobile_arena/'+myId).remove(); };
    </script>
</body>
</html>