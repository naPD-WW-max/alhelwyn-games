<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNAKE PRO | Joystick & Wall</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; touch-action: none; }
        canvas { display: block; }
        #joystick-container {
            position: fixed; bottom: 40px; left: 40px; width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1); border-radius: 50%; z-index: 2000;
            display: none; border: 2px solid rgba(255,255,255,0.3);
        }
        #joystick-knob {
            position: absolute; top: 35px; left: 35px; width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.5); border-radius: 50%;
        }
        .leaderboard { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; font-family: sans-serif; border: 1px solid #f00; z-index: 100; pointer-events: none; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; color: white; }
        .start-btn { padding: 15px 40px; background: #f00; color: #fff; border: none; border-radius: 30px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>SNAKE : JOYSTICK MODE</h1>
        <button class="start-btn" onclick="initGame()">ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿπÿ±ŸÉÿ© üêç</button>
    </div>

    <div class="leaderboard" id="leaderboard"></div>

    <div id="joystick-container">
        <div id="joystick-knob"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC_O3VFAZW3OZGrxxk2yK58Avgj-8WVs-M",
            authDomain: "alhelwyn.firebaseapp.com",
            projectId: "alhelwyn",
            databaseURL: "https://alhelwyn-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const WORLD_SIZE = 3000;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let viewX = 0, viewY = 0;

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let myId = "", players = {}, foods = {};
        let mySnake = {
            x: WORLD_SIZE/2, y: WORLD_SIZE/2,
            body: [], angle: 0, score: 0,
            color: `hsl(${Math.random() * 360}, 80%, 60%)`,
            name: "ŸÑÿßÿπÿ®"
        };

        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÄ Joystick
        const joyContainer = document.getElementById('joystick-container');
        const joyKnob = document.getElementById('joystick-knob');
        let isTouching = false;

        function initGame() {
            document.getElementById('overlay').style.display = 'none';
            if ('ontouchstart' in window) joyContainer.style.display = 'block';
            
            const ref = db.ref('final_arena').push();
            myId = ref.key;
            
            setInterval(gameLoop, 1000/60);
            db.ref('final_arena').on('value', s => players = s.val() || {});
            db.ref('final_foods').on('value', s => {
                foods = s.val() || {};
                if (Object.keys(foods).length < 50) spawnFood(25);
            });
        }

        // --- ŸÖŸÜÿ∑ŸÇ ÿπÿµÿß ÿßŸÑÿ™ÿ≠ŸÉŸÖ ---
        joyContainer.addEventListener('touchstart', (e) => { isTouching = true; });
        window.addEventListener('touchmove', (e) => {
            if (!isTouching) return;
            const touch = e.touches[0];
            const rect = joyContainer.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const dx = touch.clientX - centerX;
            const dy = touch.clientY - centerY;
            const dist = Math.min(Math.hypot(dx, dy), 50);
            const angle = Math.atan2(dy, dx);
            
            joyKnob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
            mySnake.angle = angle;
        }, { passive: false });

        window.addEventListener('touchend', () => {
            isTouching = false;
            joyKnob.style.transform = `translate(0px, 0px)`;
        });

        // ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿßŸàÿ≥ ŸÑŸÑŸÉŸÖÿ®ŸäŸàÿ™ÿ±
        window.onmousemove = (e) => {
            if (!isTouching) {
                const dx = e.clientX - canvas.width / 2;
                const dy = e.clientY - canvas.height / 2;
                mySnake.angle = Math.atan2(dy, dx);
            }
        };

        function spawnFood(n) {
            for(let i=0; i<n; i++) {
                db.ref('final_foods').push({
                    x: Math.random() * WORLD_SIZE,
                    y: Math.random() * WORLD_SIZE,
                    c: `hsl(${Math.random() * 360}, 100%, 50%)`
                });
            }
        }

        function gameLoop() {
            if(!myId) return;

            const speed = 4.5;
            mySnake.x += Math.cos(mySnake.angle) * speed;
            mySnake.y += Math.sin(mySnake.angle) * speed;

            // --- ŸÉÿ¥ŸÅ ÿ™ÿµÿßÿØŸÖ ÿßŸÑÿ≠ÿßÿ¶ÿ∑ ÿßŸÑÿµÿßÿ±ŸÖ ---
            const headRadius = 15;
            if (mySnake.x < headRadius || mySnake.x > WORLD_SIZE - headRadius || 
                mySnake.y < headRadius || mySnake.y > WORLD_SIZE - headRadius) {
                die();
                return;
            }

            mySnake.body.unshift({x: mySnake.x, y: mySnake.y});
            if(mySnake.body.length > 20 + (mySnake.score / 5)) mySnake.body.pop();

            viewX = mySnake.x - canvas.width / 2;
            viewY = mySnake.y - canvas.height / 2;

            for(let id in foods) {
                if(Math.hypot(mySnake.x - foods[id].x, mySnake.y - foods[id].y) < 25) {
                    mySnake.score += 5;
                    db.ref('final_foods/'+id).remove();
                }
            }

            db.ref('final_arena/'+myId).set(mySnake);
            draw();
        }

        function die() {
            db.ref('final_arena/'+myId).remove();
            alert("ŸÑŸÇÿØ ŸÑŸÖÿ≥ÿ™ ÿßŸÑÿ≠ÿßÿ¶ÿ∑ ÿßŸÑÿßÿ≠ŸÖÿ±! ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿßÿÆÿ±Ÿâ");
            location.reload();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-viewX, -viewY);

            // ÿ¨ÿØÿßÿ± ÿßŸÑŸÖŸàÿ™ ÿßŸÑÿ£ÿ≠ŸÖÿ±
            ctx.strokeStyle = "#ff0000";
            ctx.lineWidth = 20;
            ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);

            // ÿ±ÿ≥ŸÖ ÿßŸÑÿ∑ÿπÿßŸÖ
            for(let id in foods) {
                ctx.fillStyle = foods[id].c;
                ctx.beginPath(); ctx.arc(foods[id].x, foods[id].y, 6, 0, 7); ctx.fill();
            }

            // ÿ±ÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ
            for(let id in players) {
                const p = players[id];
                if(!p.body || p.body.length < 2) continue;
                const thick = 12 + (p.score/60);
                
                ctx.strokeStyle = p.color;
                ctx.lineWidth = thick * 2;
                ctx.lineCap = "round";
                ctx.lineJoin = "round";

                ctx.beginPath();
                ctx.moveTo(p.body[0].x, p.body[0].y);
                for(let i=1; i<p.body.length; i++) ctx.lineTo(p.body[i].x, p.body[i].y);
                ctx.stroke();

                // ÿßŸÑÿ±ÿ£ÿ≥
                ctx.save();
                ctx.translate(p.body[0].x, p.body[0].y);
                ctx.rotate(p.angle);
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.ellipse(0, 0, thick*1.5, thick*1.2, 0, 0, 7); ctx.fill();
                ctx.fillStyle = "white";
                ctx.beginPath(); ctx.arc(thick*0.7, -thick*0.4, thick*0.3, 0, 7); ctx.fill();
                ctx.beginPath(); ctx.arc(thick*0.7, thick*0.4, thick*0.3, 0, 7); ctx.fill();
                ctx.restore();
            }

            ctx.restore();
            let sorted = Object.values(players).sort((a,b) => b.score - a.score).slice(0,5);
            document.getElementById('leaderboard').innerHTML = sorted.map(p => `<div>${p.name}: ${p.score}</div>`).join('');
        }

        window.onbeforeunload = () => { if(myId) db.ref('final_arena/'+myId).remove(); };
    </script>
</body>
</html>