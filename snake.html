<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNAKE ROYAL | Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif; }
        canvas { display: block; }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; color: white; text-align: center; }
        #game-over-screen { display: none; background: rgba(30, 0, 0, 0.98); }
        
        .btn { padding: 14px 40px; margin: 8px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s; width: 220px; text-decoration: none; display: inline-block; }
        .btn-play { background: #00ff41; color: #000; box-shadow: 0 0 20px rgba(0,255,65,0.3); }
        .btn-play:hover { transform: scale(1.05); box-shadow: 0 0 30px #00ff41; }
        .btn-games { background: #007bff; color: white; box-shadow: 0 0 15px rgba(0,123,255,0.4); }
        .btn-exit { background: #333; color: white; border: 1px solid #555; }
        
        input#username { padding: 12px; border-radius: 10px; border: 2px solid #333; margin-bottom: 20px; width: 240px; text-align: center; font-size: 1.1rem; background: #111; color: white; }
        .leaderboard { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; border: 1px solid #f00; z-index: 100; min-width: 120px; font-size: 14px; }
        #joystick-container { position: fixed; bottom: 50px; left: 50px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); display: none; z-index: 2000; }
        #joystick-knob { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: rgba(255,255,255,0.4); border-radius: 50%; }
    </style>
</head>
<body>

    <div id="start-screen" class="overlay">
        <h1 style="color: #00ff41; font-size: 3rem; margin-bottom: 5px;">SNAKE ROYAL</h1>
        <p style="color: #888; margin-bottom: 25px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¹Ø±ÙƒØ©</p>
        
        <input type="text" id="username" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="12">
        
        <button class="btn btn-play" onclick="initGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ âš”ï¸</button>
        <a href="index.html" class="btn btn-games">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ GAMES ğŸ®</a>
    </div>

    <div id="game-over-screen" class="overlay">
        <h1 style="color: #ff0000; font-size: 3.5rem;">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h1>
        <p id="final-score" style="font-size: 1.6rem; margin-bottom: 25px;">Ù†Ù‚Ø§Ø·Ùƒ: 0</p>
        
        <button class="btn btn-play" onclick="restartGame()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨ ğŸ”„</button>
        <button class="btn btn-exit" onclick="backToMain()">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ğŸ </button>
    </div>

    <div class="leaderboard" id="leaderboard"></div>
    <div id="joystick-container"><div id="joystick-knob"></div></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ ---
        const firebaseConfig = {
            apiKey: "AIzaSyC_O3VFAZW3OZGrxxk2yK58Avgj-8WVs-M",
            authDomain: "alhelwyn.firebaseapp.com",
            projectId: "alhelwyn",
            databaseURL: "https://alhelwyn-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const WORLD_SIZE = 3000;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let viewX = 0, viewY = 0, myId = "", gameActive = false;
        let players = {}, foods = {};

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let mySnake = {
            x: WORLD_SIZE/2, y: WORLD_SIZE/2,
            body: [], angle: 0, score: 0,
            color: `hsl(${Math.random() * 360}, 80%, 60%)`,
            name: "Ù„Ø§Ø¹Ø¨"
        };

        function initGame() {
            const nameInput = document.getElementById('username').value;
            mySnake.name = nameInput || "Ø­Ù„Ùˆ";
            mySnake.score = 0;
            mySnake.body = [];
            mySnake.x = WORLD_SIZE/2;
            mySnake.y = WORLD_SIZE/2;

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'none';
            if ('ontouchstart' in window) document.getElementById('joystick-container').style.display = 'block';
            
            const ref = db.ref('royal_arena').push();
            myId = ref.key;
            gameActive = true;
            
            if (!window.gameInterval) window.gameInterval = setInterval(gameLoop, 1000/60);
            
            db.ref('royal_arena').on('value', s => players = s.val() || {});
            db.ref('royal_foods').on('value', s => foods = s.val() || {});
        }

        function spawnFood(n) {
            for(let i=0; i<n; i++) {
                db.ref('royal_foods').push({
                    x: Math.random() * WORLD_SIZE, y: Math.random() * WORLD_SIZE,
                    c: `hsl(${Math.random() * 360}, 100%, 50%)`, v: 5
                });
            }
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… ---
        let joyTouching = false;
        const joyKnob = document.getElementById('joystick-knob');
        window.addEventListener('touchmove', (e) => {
            const rect = document.getElementById('joystick-container').getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const dx = e.touches[0].clientX - centerX;
            const dy = e.touches[0].clientY - centerY;
            const dist = Math.min(Math.hypot(dx, dy), 40);
            const angle = Math.atan2(dy, dx);
            joyKnob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
            mySnake.angle = angle;
            joyTouching = true;
        }, {passive: false});
        window.addEventListener('touchend', () => { joyTouching = false; joyKnob.style.transform = "translate(0,0)"; });
        window.onmousemove = (e) => { if(!joyTouching) mySnake.angle = Math.atan2(e.clientY - canvas.height/2, e.clientX - canvas.width/2); };

        function gameLoop() {
            if(!myId || !gameActive) return;
            mySnake.x += Math.cos(mySnake.angle) * 4.5;
            mySnake.y += Math.sin(mySnake.angle) * 4.5;

            // Ø§Ù„Ù…ÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø±
            if (mySnake.x < 15 || mySnake.x > WORLD_SIZE-15 || mySnake.y < 15 || mySnake.y > WORLD_SIZE-15) {
                die(); return;
            }

            mySnake.body.unshift({x: mySnake.x, y: mySnake.y});
            if(mySnake.body.length > 20 + (mySnake.score/5)) mySnake.body.pop();

            viewX = mySnake.x - canvas.width / 2;
            viewY = mySnake.y - canvas.height / 2;

            for(let id in foods) {
                if(Math.hypot(mySnake.x - foods[id].x, mySnake.y - foods[id].y) < 25) {
                    mySnake.score += foods[id].v || 5;
                    db.ref('royal_foods/'+id).remove();
                }
            }
            if (Object.keys(foods).length < 50) spawnFood(20);
            db.ref('royal_arena/'+myId).set(mySnake);
            draw();
        }

        function die() {
            gameActive = false;
            mySnake.body.forEach((p, i) => {
                if(i % 3 === 0) db.ref('royal_foods').push({ x: p.x, y: p.y, c: mySnake.color, v: 15 });
            });
            db.ref('royal_arena/'+myId).remove();
            document.getElementById('final-score').innerText = "Ù†Ù‚Ø§Ø·Ùƒ: " + Math.floor(mySnake.score);
            document.getElementById('game-over-screen').style.display = 'flex';
        }

        function restartGame() { initGame(); }
        
        function backToMain() {
            document.getElementById('game-over-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('joystick-container').style.display = 'none';
            gameActive = false;
            myId = "";
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-viewX, -viewY);
            // Ø±Ø³Ù… Ø§Ù„Ø­Ø¯ÙˆØ¯
            ctx.strokeStyle = "red"; ctx.lineWidth = 20;
            ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);
            // Ø±Ø³Ù… Ø§Ù„Ø·Ø¹Ø§Ù…
            for(let id in foods) {
                ctx.fillStyle = foods[id].c;
                let size = (foods[id].v > 5) ? 10 : 5;
                ctx.beginPath(); ctx.arc(foods[id].x, foods[id].y, size, 0, 7); ctx.fill();
            }
            // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            for(let id in players) {
                const p = players[id];
                if(!p.body || p.body.length < 2) continue;
                const thick = 12 + (p.score/60);
                ctx.strokeStyle = p.color; ctx.lineWidth = thick*2; ctx.lineCap="round";
                ctx.beginPath();
                ctx.moveTo(p.body[0].x, p.body[0].y);
                for(let i=1; i<p.body.length; i++) ctx.lineTo(p.body[i].x, p.body[i].y);
                ctx.stroke();
                // Ø§Ù„Ø±Ø£Ø³
                ctx.save();
                ctx.translate(p.body[0].x, p.body[0].y); ctx.rotate(p.angle);
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.ellipse(0, 0, thick*1.4, thick*1.1, 0, 0, 7); ctx.fill();
                ctx.fillStyle="white"; ctx.beginPath(); ctx.arc(thick*0.7, -thick*0.4, thick*0.3, 0, 7); ctx.fill();
                ctx.beginPath(); ctx.arc(thick*0.7, thick*0.4, thick*0.3, 0, 7); ctx.fill();
                ctx.restore();
            }
            ctx.restore();
            let sorted = Object.values(players).sort((a,b) => b.score - a.score).slice(0,5);
            document.getElementById('leaderboard').innerHTML = sorted.map(p => `<div>${p.name}: ${Math.floor(p.score)}</div>`).join('');
        }
    </script>
</body>
</html>